#!/bin/bash

# Runs a command wrapped in btrfs snapper pre-post snapshots
# Usage: $ snp <commands>
# e.g.: $ snp sudo pacman -Syu

[[ $EUID -eq 0 ]] || { echo "Put sudo before snp"; exit 1; }

log_path="/var/log/snp"
date=$(date "+%Y-%m-%d-%H%M%S")
log_file="${log_path}/snp_${date}.log"

[ -d ${log_path} ] || { mkdir -p ${log_path}; }

arg="$@"
[[ "${arg}" =~ ^sudo.* ]] && { echo "Don't put sudo before pacman/yay"; exit 1; }

echo "Logging to: ${log_file}"

{
   snapshot_nbr=$(snapper create --type=pre --cleanup-algorithm=number --print-number --description="${arg}")
   echo "New pre snapshot with number ${snapshot_nbr}"
   echo "Running command \"${arg}\""

   [[ "$arg" =~ ^pacman.* ]] && { cmd="${arg}"; }
   [[ "$arg" =~ ^yay.* ]] && { cmd="sudo -u narcizo ${arg}"; }
   eval "$cmd"

   snapshot_nbr=$(snapper create --type=post --cleanup-algorithm=number --print-number --pre-number="${snapshot_nbr}")
   echo -e "\nNew post snapshot with number ${snapshot_nbr}\n"
} | tee $log_file

exit 0
