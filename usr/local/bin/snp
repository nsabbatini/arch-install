#!/bin/bash

# Runs a command wrapped in btrfs snapper pre-post snapshots
# Usage: $ sudo snp <commands>
# e.g.: $ sudo snp pacman -Syu

[[ $EUID -eq 0 ]] || { echo "Put sudo before snp"; exit 1; }

log_path="/var/log/snp"
date=$(date "+%Y-%m-%d-%H%M%S")
log_file="${log_path}/snp_${date}.log"

[ -d ${log_path} ] || { mkdir -p ${log_path}; }

arg="$@"
[[ "${arg}" =~ ^sudo.* ]] && { echo "Command after snp does not need sudo"; exit 1; }

echo "Logging to: ${log_file}"

exec &> >(tee -a ${log_file})

snapshot_nbr=$(snapper create --type=pre --cleanup-algorithm=number --print-number --description="${arg}")
echo "New pre snapshot with number ${snapshot_nbr}"
echo "Running command \"${arg}\""

if [[ "$arg" =~ ^yay.* ]]; then
    cmd="sudo -u narcizo stdbuf -oL -eL ${arg}"
else
    cmd="stdbuf -oL -eL ${arg}"
fi

eval "$cmd"

snapshot_nbr=$(snapper create --type=post --cleanup-algorithm=number --print-number --pre-number="${snapshot_nbr}")
echo -e "\nNew post snapshot with number ${snapshot_nbr}\n"

exit 0
