#!/bin/bash
# ----------------------------------------------------------------------
# Rotating-filesystem-snapshot utility
# ----------------------------------------------------------------------
# Makes daily snapshots using rsync, keeping 7 rotating copies.
# Since hard links are used to copy files, additional disk space is
# needed only for new or modified files
# ----------------------------------------------------------------------

PATH="/usr/local/bin:/usr/bin:/usr/sbin"

# Logs to systemd journal
Say(){
    echo $1 | systemd-cat -t snapshot-daily -p $2
}

# Remove temp files
cleanup_exit() {
[[ -f $stamp ]] && { rm $stamp; }
exit $1
}

[[ $EUID -eq 0 ]] || { Say "Need to run as root" "err"; cleanup_exit 1; }

user="narcizo"
host=$(hostname)
nas_ip="192.168.1.104"

# This script is run under root, but we will make rsync use ssh config and keys from $user
ssh_opt="-F /home/$user/.ssh/config -i /home/$user/.ssh/id_rsa"

# nas_dir is the backup destination directory on the NAS server
nas_dir="/share/linux-backup/${host}"
ssh_dest="${user}@${nas_ip}"
rsync_dest="${ssh_dest}:${nas_dir}"

# /etc/snapshot contains a file with paths to be excluded from the snapshot
# We require that this file exists, even if empty
exc="/etc/snapshot/snapshot-exclude-${host}"
[[ -f $exc ]] || { Say "/etc/snapshot/snapshot-exclude-${host} does not exist" "err"; cleanup_exit 1; }

# Check if network is up and we can reach the NAS
nas_ping=0
for i in {1..30}; do
   ping -c 1 -W 1 $nas_ip &> /dev/null
   [[ $? -eq 0 ]] && { nas_ping=1; break; }
   sleep 2
done
[[ $nas_ping -eq 1 ]] || { Say "ping to NAS failed" "err"; cleanup_exit 1; }

# Create temporaty stamp file and give it normal user permissions
stamp=/tmp/snapshot_stamp$$
echo "Latest daily snapshot: $(date)" > $stamp
chown 1000:1000 $stamp

# Check if destination directory on NAS exists, and create one if not
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir ]] || { mkdir ${nas_dir}; chown 1000:1000 ${nas_dir}; }"
rsync -e "ssh $ssh_opt" -a --numeric-ids --rsync-path='sudo rsync' $stamp ${rsync_dest}/.snapshot_daily 2>/dev/null
[[ $? -eq 0 ]] || { Say "could not write to the NAS destination directory" "err"; cleanup_exit 1; }

Say "creating daily snapshot of $host" "info"

# step 1: delete the oldest snapshot, if it exists:
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.6 ]] && { sudo rm -rf ${nas_dir}/daily.6; }"

# step 2: shift the middle snapshots(s) back by one, if they exist
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.5 ]] && { sudo mv ${nas_dir}/daily.5 ${nas_dir}/daily.6; }"
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.4 ]] && { sudo mv ${nas_dir}/daily.4 ${nas_dir}/daily.5; }"
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.3 ]] && { sudo mv ${nas_dir}/daily.3 ${nas_dir}/daily.4; }"
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.2 ]] && { sudo mv ${nas_dir}/daily.2 ${nas_dir}/daily.3; }"
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.1 ]] && { sudo mv ${nas_dir}/daily.1 ${nas_dir}/daily.2; }"

# step 3: make a hard-link-only (except for dirs) copy of the latest snapshot, if that exists
ssh $ssh_opt $ssh_dest "[[ -d ${nas_dir}/daily.0 ]] && { sudo cp -al ${nas_dir}/daily.0 ${nas_dir}/daily.1; }"

# step 4: create a snapper snapshot to use as source; this guarantees data consistency;
# then rsync from the source into the latest snapshot (notice that rsync behaves
# like cp --remove-destination by default, so the destination is unlinked first.
# If it were not so, this would copy over the other snapshot(s) too!
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/daily.0 ]] || { mkdir ${nas_dir}/daily.0; chown 1000:1000 ${nas_dir}/daily.0; }"
snp=$(snapper -c home create --type=single --cleanup-algorithm=number --print-number --description="backup")
src="/home/.snapshots/$snp/snapshot/${user}"
rsync_opt="-a --delete --delete-excluded --stats --exclude-from=$exc --numeric-ids"
rsync -e "ssh $ssh_opt" $rsync_opt --rsync-path='sudo rsync' $src ${rsync_dest}/daily.0

# step 5: update the mtime of daily.0 to reflect the snapshot time
ssh $ssh_opt $ssh_dest "touch ${nas_dir}/daily.0"

# Delete snapper snapshot
snapper -c home delete $snp

Say "finished $host daily snapshot" "info"

cleanup_exit 0
