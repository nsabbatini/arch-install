#!/bin/bash
# ----------------------------------------------------------------------
# Rotating-filesystem-snapshot utility
# ----------------------------------------------------------------------
# Makes monthly snapshots, keeping 6 rotating copies. The most recent
# snapshot is copied with hard links from the oldest weekly snapshot,
# therefore this script will not work without the snapshot-weekly script.
# ----------------------------------------------------------------------

PATH="/usr/local/bin:/usr/bin:/usr/sbin"

# Logs to systemd journal
Say(){
    echo $1 | systemd-cat -t snapshot-monthly -p $2
}

# Remove temp files
cleanup_exit() {
[[ -f $stamp ]] && { rm $stamp; }
exit $1
}

[[ $EUID -eq 0 ]] || { Say "Need to run as root" "err"; exit 1; }

user="narcizo"
host=$(hostname)
nas_ip="192.168.1.104"

# This script is run under root, but we will make rsync use ssh config and keys from $user
ssh_opt="-F /home/$user/.ssh/config -i /home/$user/.ssh/id_rsa"

# nas_dir is the backup destination directory on the NAS server
nas_dir="/share/linux-backup/${host}"
ssh_dest="${user}@${nas_ip}"
rsync_dest="${ssh_dest}:${nas_dir}"

# Check if network is up and we can reach the NAS
nas_ping=0
for i in {1..30}; do
   ping -c 1 -W 1 $nas_ip &> /dev/null
   [[ $? -eq 0 ]] && { nas_ping=1; break; }
   sleep 2
done
[[ $nas_ping -eq 1 ]] || { Say "ping to NAS failed" "err"; exit 1; }

ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/weekly.3 ]]" || { Say "weekly.3 not found, skipping snapshot" "info"; exit 0; }

# Create temporaty stamp file and give it normal user permissions
stamp=/tmp/snapshot_stamp$$
echo "Latest montly snapshot: $(date)" > $stamp
chown 1000:1000 $stamp

# Check that we can write to the NAS
rsync -a -e "ssh $ssh_opt" --numeric-ids --rsync-path='sudo rsync' $stamp ${rsync_dest}/.snapshot_montly 2>/dev/null
[[ $? -eq 0 ]] || { Say "could not write to the NAS" "err"; cleanup_exit 1; }

Say "creating montly snapshot of $host" "info"

# step 1: delete the oldest snapshot, if it exists:
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/monthly.5 ]] && { sudo rm -rf $nas_dir/monthly.5; }"

# step 2: shift the middle snapshots(s) back by one, if they exist
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/monthly.4 ]] && { sudo mv $nas_dir/monthly.4 $nas_dir/monthly.5; }"
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/monthly.3 ]] && { sudo mv $nas_dir/monthly.3 $nas_dir/monthly.4; }"
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/monthly.2 ]] && { sudo mv $nas_dir/monthly.2 $nas_dir/monthly.3; }"
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/monthly.1 ]] && { sudo mv $nas_dir/monthly.1 $nas_dir/monthly.2; }"
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/monthly.0 ]] && { sudo mv $nas_dir/monthly.0 $nas_dir/monthly.1; }"

# step 3: make a hard-link-only (except for dirs) copy of weekly.3 into monthly.0
ssh $ssh_opt $ssh_dest "[[ -d $nas_dir/weekly.3 ]] && { sudo cp -al $nas_dir/weekly.3 $nas_dir/monthly.0; }"

# note: do not update the mtime of montly.0; it will reflect the creation time of weekly.3
Say "finished montly snapshot of $host" "info"

cleanup_exit 0
